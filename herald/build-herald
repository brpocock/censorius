#!/bin/sh
PATH=~/bin:$PATH
[ -d "$(dirname "$0")" ] && cd "$(dirname "$0")" || \
        [ -d ~/herald ] && cd ~/herald || \
                [ -d ~/Projects/censorius/herald ] && cd ~/Projects/censorius/herald || \
                        exit 2
mv --backup=numbered herald herald.backup
buildapp --output herald \
	--logfile herald.buildapp.log \
	--load ~/quicklisp/setup.lisp \
	--asdf-path $(pwd) \
        --asdf-path $(pwd)/elephant \
        --load build.lisp \
	--dispatched-entry herald.cgi/herald-fcgi:exec-cgi \
	--dispatched-entry herald.fcgi/herald-fcgi:exec-fcgi \
	--dispatched-entry /herald-fcgi:exec-cgi \
	--dispatched-entry herald.repl/herald-fcgi:exec-repl \
&& ln -f ./herald ../bin/herald.repl \
&& ln -f ./herald ../fpgrocks.org/reg/herald.cgi \
&& echo '  ★  ★  ★  ★  ★  ★  ★  ★  ★  ★  Victory is mine.'

tail -n 20 herald.buildapp.log

echo "Version running in Production:"
curl -d 'verb=about&deployment-marker=t' 'http://www.fpgrocks.org/reg/herald.cgi'
echo "Version running in Test:"
curl -d 'verb=about&deployment-marker=t' 'http://www.fpgrocks.org/reg/test/herald.cgi'


